<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.node text {
  font: 9px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

</style>
<body>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script>

var width = 960,
    height = 700;

var color = d3.scale.category20();

var force = d3.layout.force()
    .charge(-120)
    .gravity(0)
    .linkDistance(function(d) { return  d.distance; })
    .size([width, height]);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

d3.csv("full.csv").get(function(error, rows) {
  
  var graph = {
    "nodes" : [],
    "links" : []
  }
  for (var i = 0; i < rows.length; i++) {
    var node = {};
    node.name = rows[i].lang;
    node.group = rows[i].group;
    node.hasLink = false;
    graph.nodes.push(node);
  }
  
  for (var i = 0; i < rows.length; i++) {
    for (var j = 0; j < graph.nodes.length; j++) {
      if (i < j && (rows[i].group === rows[j].group || parseFloat(rows[i][graph.nodes[j].name]) < 0.40)) {
        var link = {};
        link.source = i;
        link.target = j;
        link.value = 2;
        link.distance = 10;
        graph.nodes[i].hasLink = true;
        graph.nodes[j].hasLink = true;
        graph.links.push(link);
      }
    }
  }
  
  // adding any link to group those without any groups
  for (var i = 0; i < graph.nodes.length; i++) {
    if (!graph.nodes[i].hasLink) {
      var smallest = 10;
      var smallestIndex = -1;
      for (var j = 0; j < rows.length; j++) {
        if (i != j) {
          var distance = parseFloat(rows[i][graph.nodes[j].name]);
          if (distance < smallest) {
            smallest = distance;
            smallestIndex = j;
          }
        }
      }
      var link = {};
      link.source = i;
      link.target = smallestIndex;
      link.value = 1;
      link.distance = 40;
      graph.links.push(link);
    }
  }
  
  // add links between groups where there are less than two links
  var newLinks = [
    { source: 1, target: 19, value: 1, distance: 60},
    { source: 1, target: 15, value: 1, distance: 60},
    { source: 25, target: 5, value: 1, distance: 60},
    { source: 16, target: 12, value: 1, distance: 60},
    { source: 14, target: 4, value: 1, distance: 60},
    { source: 12, target: 10, value: 1, distance: 60},
    { source: 24, target: 15, value: 1, distance: 60},
    { source: 27, target: 16, value: 1, distance: 60},
    { source: 23, target: 3, value: 1, distance: 60},
    { source: 6, target: 5, value: 1, distance: 60}
  ]
  
  for (var i = 0; i < newLinks.length; i++) {
    graph.links.push(newLinks[i]);
  }
  
  // recalculate distances based on their real distances
  // smallest - 5px, biggest - 80px
  var smallestDistance = 666.0;
  var biggestDistance = -1.0;
  for (var i = 0; i < rows.length; i++) {
    for (var j = i + 1; j < rows.length; j++) {
        var distance = parseFloat(rows[i][rows[j].lang]);
        if (distance < smallestDistance) {
            smallestDistance = distance;
        }
        if (distance > biggestDistance) {
            biggestDistance = distance;
        }
    }
  }
  
  for (var i = 0; i < graph.links.length; i++) {
    var foundDistance = parseFloat(rows[graph.links[i].source][rows[graph.links[i].target].lang]);
    graph.links[i].distance = 5.0 + 75.0 * (foundDistance - smallestDistance) / (biggestDistance - smallestDistance);
  }
  
    force
      .nodes(graph.nodes)
      .links(graph.links)
      .linkDistance(height/8)
      .start();

  var link = svg.selectAll(".link")
      .data(graph.links)
    .enter().append("line")
      .attr("class", "link")
      .style("stroke-width", function(d) { return d.value; });

var node = svg.selectAll(".node")
    .data(graph.nodes)
    .enter().append("g")
    .attr("class", "node")
    .call(force.drag);

node.append("circle")
    .attr("r", 12)
    .style("fill", function (d) {
    return color(d.group);
})

node.append("text")
      .attr("dx", 10)
      .attr("dy", ".35em")
      .text(function(d) { return d.name })
      .style("stroke", "gray");

  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    d3.selectAll("circle").attr("cx", function (d) {
        return d.x;
    })
        .attr("cy", function (d) {
        return d.y;
    });

    d3.selectAll("text").attr("x", function (d) {
        return d.x;
    })
        .attr("y", function (d) {
        return d.y;
    });
  });
});  

</script>
</body>
</html>
